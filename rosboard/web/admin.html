<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <title>Admin Panel - Autonomous Oil Palm Harvesting Robot System</title>

  <link rel="stylesheet" href="/static/css/material.indigo-blue.min.css">
  <link href="/static/css/material-icons.css" rel="stylesheet"> 
  <link href="/static/css/index.css" rel="stylesheet" type="text/css"> 

  <script src="/static/js/jquery-3.1.0.min.js"></script>
  <script src="/static/js/material.min.js" defer></script>

  <style>
    /* Base MDL Layout Overrides */
    main.mdl-layout__content { background: #202020 !important; } /* Main Page Background */
    .mdl-layout__drawer { background: #404040 !important; }
    .mdl-layout__header { background: #3f51b5; } /* Standard MDL blue */

    /* Container Styling */
    .admin-content { padding: 24px; color: #f0f0f0; } 
    .container, .admin-section {
        background: #303030; /* Dark background for the modules */
        color: #f0f0f0; /* Light text color */
        border-radius: 5px; padding: 20px; 
        margin-bottom: 20pt; box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
    }

    h1, h2, h3, label { color: #c0c0c0 !important; }
    
    /* Input and Select Styling */
    
    /* ðŸš¨ FIX: Force dark background on native input/select elements (fixes the white box) */
    input, select, button {
        background: #383838;
        color: #f0f0f0;
        border: 1px solid #505050;
    }
    
    /* MDL Textfield Overrides (fixes the white input area within MDL component) */
    .mdl-textfield__input {
        background: transparent !important; 
        color: #f0f0f0 !important;
        border-bottom-color: rgba(255,255,255,0.3) !important;
    }
    .mdl-textfield__label { color: rgba(255,255,255,0.5) !important; }

    /* Table Styling (ensuring dark mode) */
    .users-table { background: #404040; color: #c0c0c0; }
    .users-table th { background: #3f51b5; color: white; }
    .users-table td { border: 1px solid #505050; color: #c0c0c0; }
    .users-table tr:nth-child(even) { background-color: #383838; }

    /* Delete Button Styling */
    .delete-btn { color: #ff5252; min-width: auto; }
    .delete-btn:hover { background: rgba(255, 82, 82, 0.1); }
  </style>
</head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer">
    
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <div class="mdl-layout__drawer-button">
          <i class="material-icons">menu</i>
        </div>
        <span class="mdl-layout-title">Admin Panel</span>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
          <a class="mdl-navigation__link" href="http://localhost:8888" style="color: white;">
            <i class="material-icons">home</i> Back to Main
          </a>
        </nav>
      </div>
    </header>
    
    <div class="mdl-layout__drawer">
      <span class="mdl-layout-title">Menu</span> 
      <nav id="topics-nav" class="mdl-navigation">
        <a class="mdl-navigation__link" href="http://localhost:8888">
          <i class="material-icons">dashboard</i> Dashboard
        </a>
        
        <div class="topics-nav-title">ROBOT 2</div>
        
        <div style="opacity:0.3;" id="topics-nav-unsupported"></div>

        <div class="sidebar-user-info" id="user-links">
          <div style="padding: 16px; text-align: center; color: #888;">
            Loading user info...
          </div>
        </div>
      </nav>
    </div>

    <main class="mdl-layout__content">
      <div class="admin-content">
        <div class="container admin-section">
          <h3>Create New User</h3>
          <form class="admin-form" id="create-user-form"> 
            <div class="form-group">
              <label for="user-email">New user email</label>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="email" id="user-email" required>
                <label class="mdl-textfield__label" for="user-email">Enter email address</label>
              </div>
            </div>
            
            <div class="form-group">
              <label for="user-password">Password (min 6 chars)</label>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="password" id="user-password" pattern=".{6,}" required>
                <label class="mdl-textfield__label" for="user-password">Enter password</label>
                <span class="mdl-textfield__error">Password must be at least 6 characters</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="user-role-create">Role</label>
              <select id="user-role-create" class="mdl-textfield__input"> 
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            
            <div class="admin-actions">
              <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                <i class="material-icons">person_add</i>
                Create User
              </button>
            </div>
          </form>
        </div>

        <div class="container admin-section">
          <h3>Existing Users</h3>
          <table class="users-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td colspan="3" style="text-align: center;">Loading users...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div id="snackbar" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
  </div>

  <script>
    const LOGIN_SERVER_URL = 'http://localhost:8000';
    const ROSBOARD_URL = 'http://localhost:8888';

    const showSnackbar = (message, timeout = 4000) => {
      const snackbar = document.getElementById('snackbar');
      if (snackbar && snackbar.MaterialSnackbar) { snackbar.MaterialSnackbar.showSnackbar({ message, timeout }); } else { console.warn('Snackbar not fully initialized.', message); }
    };

    const updateUserRole = (userId, newRole) => {
      fetch(`/api/users/${userId}/role`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ role: newRole }) })
      .then(response => { if (!response.ok) throw new Error('Role update failed on server.'); showSnackbar(`User role updated to ${newRole}.`); })
      .catch(error => { console.error("Error updating role:", error); showSnackbar(`Failed to update role: ${error.message}`, 6000); });
    };

    const deleteUser = (userId, email, row) => {
      if (!confirm(`Are you sure you want to delete user: ${email}? This action is irreversible.`)) return;
      fetch(`/api/users/${userId}`, { method: 'DELETE' })
        .then(response => { if (!response.ok) throw new Error(`Deletion failed: ${response.statusText}`); return response.json(); })
        .then(() => { row.remove(); showSnackbar(`User ${email} deleted successfully`); })
        .catch(error => { console.error("Error deleting user:", error); showSnackbar(`Failed to delete user: ${error.message}`, 6000); });
    };
    
    const renderUserRow = (user) => {
      const row = document.createElement('tr');
      row.setAttribute('data-user-id', user.id);
      row.innerHTML = `
        <td>${user.email}</td>
        <td>
            <select class="role-selector" data-user-id="${user.id}" style="width: 100px;">
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
        </td>
        <td>
          <button class="mdl-button mdl-js-button mdl-button--icon delete-btn" data-user-id="${user.id}" data-user-email="${user.email}">
            <i class="material-icons">delete</i>
          </button>
        </td>`;
      
      const deleteButton = row.querySelector('.delete-btn');
      deleteButton.addEventListener('click', function() { deleteUser(this.getAttribute('data-user-id'), this.getAttribute('data-user-email'), row); });
      const roleSelector = row.querySelector('.role-selector');
      roleSelector.addEventListener('change', function() { updateUserRole(this.getAttribute('data-user-id'), this.value); });
      if (typeof componentHandler !== 'undefined') { componentHandler.upgradeElement(deleteButton); }
      return row;
    };
    
    const fetchAndRenderUsers = () => {
      const tableBody = document.getElementById('users-table-body');
      tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #aaa;">Loading users...</td></tr>';

      fetch('/api/users')
        .then(response => {
          if (!response.ok) {
            if (response.status === 403) { showSnackbar("Error: Not authorized. Redirecting to dashboard.", 5000); setTimeout(() => window.location.href = ROSBOARD_URL, 1000); }
            throw new Error(`Failed to load users: ${response.status}`);
          }
          return response.json();
        })
        .then(users => {
          tableBody.innerHTML = ''; 
          users.forEach(user => { tableBody.appendChild(renderUserRow(user)); });
        })
        .catch(error => {
          if (error.message !== 'Unauthorized') { console.error("Error loading users:", error); }
        });
    };

    document.addEventListener("DOMContentLoaded", function() {
      if (typeof componentHandler !== 'undefined') { componentHandler.upgradeAllRegistered(); }

      const userLinksContainer = document.getElementById("user-links");
      const createForm = document.getElementById('create-user-form');
      
      fetch(`${LOGIN_SERVER_URL}/api/get_session`, {credentials: 'include'})
        .then(response => {
          if (!response.ok) { window.location.href = '/login'; throw new Error('Not authenticated'); }
          return response.json();
        })
        .then(user => {
          let linksHtml = '';
          if (user.role === 'admin') { linksHtml += `<a class="mdl-navigation__link" href="/admin"><i class="material-icons">admin_panel_settings</i> Admin Panel</a>`; }
          linksHtml += `
            <div class="email" title="${user.email}">${user.email}</div>
            <a class="mdl-navigation__link" href="/logout"><i class="material-icons">logout</i> Logout</a>`;
          userLinksContainer.innerHTML = linksHtml;
          
          if (typeof componentHandler !== 'undefined') { componentHandler.upgradeElements(userLinksContainer); }
          
          fetchAndRenderUsers(); 
        })
        .catch(error => {
          if (error.message !== 'Not authenticated') { console.error("Error fetching user session:", error); }
          window.location.href = '/login';
        });

      createForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('user-email').value; 
        const password = document.getElementById('user-password').value; 
        const role = document.getElementById('user-role-create').value; 
        
        if (password.length < 6) { showSnackbar("Password must be at least 6 characters.", 3000); return; }

        fetch('/api/users', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role })
        })
        .then(response => {
          if (response.status === 403) throw new Error('Permission denied. Session expired?');
          if (!response.ok) { return response.json().then(data => { throw new Error(data.error || 'Server error during creation.'); }); }
          return response.json();
        })
        .then(newUserArray => {
          const newUser = newUserArray[0]; 
          showSnackbar(`User ${newUser.email} created successfully as ${newUser.role}`);
          
          const tableBody = document.getElementById('users-table-body');
          tableBody.appendChild(renderUserRow(newUser));

          createForm.reset();
          
          const fields = createForm.querySelectorAll('.mdl-js-textfield');
          fields.forEach(field => { if (field.MaterialTextfield) field.MaterialTextfield.change(); });
        })
        .catch(error => {
          console.error('Error creating user:', error);
          showSnackbar(`Failed to create user: ${error.message}`, 6000);
        });
      });
    });
  </script>
