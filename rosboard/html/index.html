<!doctype html>
<html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
        <link href="css/material-icons.css" media="all" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="js/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="></script>
        <link rel="stylesheet" href="css/material.indigo-blue.min.css" />
        <link rel="stylesheet" href="css/uPlot.min.css">
        <link rel="stylesheet" href="css/leaflet.css">
        <link href="css/index.css" media="all" rel="stylesheet" type="text/css">
        
        <script type="text/javascript" src="js/json5.min.js"></script>
        <script type="text/javascript" src="js/uPlot.iife.min.js"></script>
        <script type="text/javascript" src="js/jquery.transit.min.js"></script>
        <script type="text/javascript" src="js/masonry.pkgd.min.js"></script>
        <script type="text/javascript" src="js/eventemitter2.min.js"></script>
        <script text="text/javascript" src="js/import-helper.js"></script>
        <script type="text/javascript" src="js/material.min.js" defer></script>
        <script type="text/javascript" src="js/leaflet.js"></script> Â  Â  Â  Â 
        <script type="text/javascript" src="js/gl-matrix.js"></script>
        <script type="text/javascript" src="js/litegl.min.js"></script>
        <script type="text/javascript" src="js/index.js" defer></script>

        <title>Autonomous Oil Palm Harvesting Robot System</title>
    </head>
    <body>
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
          <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
              
              <span class="mdl-layout-title">Autonomous Oil Palm Harvesting Robot System</span>
              
              <div class="mdl-layout-spacer"></div>
              
              <span id="admin-button-container"></span>
              
            </div>
          </header>
          <div class="mdl-layout__drawer">
            <nav id="topics-nav" class="mdl-navigation">
                <div id="topics-nav-system-title" class="topics-nav-title">System</div>
                <div id="topics-nav-system"></div>
                <div id="topics-nav-ros-title" class="topics-nav-title">ROS topics</div>
                <div id="topics-nav-ros"></div>
                <div style="opacity:0.3;" id="topics-nav-unsupported"></div>
            </nav>
          </div>
          <main class="mdl-layout__content">
            <div class="page-content">
              <div class="grid">
              </div>
            </div>
          </main>
        </div>
        
  <div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
  </div>

    </body>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('admin-button-container');
            const LOGIN_SERVER_URL = 'http://localhost:8000';

            // Function to fetch session data from the Login Server
            fetch(`${LOGIN_SERVER_URL}/api/get_session`, {credentials: 'include'})
                .then(response => {
                    // Check for network errors, 401 Unauthorized, or 403 Forbidden
                    if (response.status === 401 || response.status === 403 || !response.ok) {
                        // User not logged in/session expired, redirect them
                        window.location.href = `${LOGIN_SERVER_URL}/login`;
                        return null; // Stop processing
                    }
                    return response.json();
                })
                .then(user => {
                    if (!user) return; // Stop if redirect happened above

                    if (user && user.role === 'admin') {
                        // Create the Admin Button element
                        const adminButton = document.createElement('a');
                        adminButton.href = `${LOGIN_SERVER_URL}/admin`;
                        adminButton.textContent = 'Admin Panel';
                        
                        // Apply Material Design Lite (MDL) button classes
                        adminButton.className = 'mdl-button mdl-js-button mdl-button--raised mdl-button--colored';
                        adminButton.style.marginRight = '20px';
                        adminButton.style.padding = '0 16px';
                        
                        // ðŸŸ¢ FIX: Set a smaller border radius for the button
                        adminButton.style.borderRadius = '4px'; 
                        
                        // Add an icon for clarity
                        const adminIcon = document.createElement('i');
                        adminIcon.className = 'material-icons';
                        adminIcon.textContent = 'admin_panel_settings';
                        adminIcon.style.marginRight = '8px';

                        adminButton.prepend(adminIcon);
                        
                        // Insert the button into the header row
                        container.appendChild(adminButton);

                        // Ensure MDL component is upgraded
                        if (componentHandler) {
                            componentHandler.upgradeElement(adminButton);
                        }
                    }
                })
                .catch(error => {
                    console.error("Network Error when checking session:", error);
                    // This catches general network failures (e.g., server 8000 is down)
                    window.location.href = `${LOGIN_SERVER_URL}/login`; 
                });

            // Force set the title to your desired text (as backup)
            const layoutTitle = document.querySelector('.mdl-layout-title');
            if (layoutTitle && layoutTitle.textContent !== 'Autonomous Oil Palm Harvesting Robot System') {
                layoutTitle.textContent = 'Autonomous Oil Palm Harvesting Robot System';
            }
        });

        // Targeted cleanup for unwanted text nodes directly in body
        document.addEventListener('DOMContentLoaded', function() {
            function removeUnwantedTextNodes() {
                // Get all direct child nodes of body
                const bodyChildren = document.body.childNodes;
                
                // Loop through all child nodes (including text nodes)
                for (let i = bodyChildren.length - 1; i >= 0; i--) {
                    const node = bodyChildren[i];
                    
                    // Check if it's a text node with unwanted content
                    if (node.nodeType === Node.TEXT_NODE) {
                        const textContent = node.textContent;
                        
                        // Remove text nodes that contain the unwanted entities or are just whitespace
                        if (textContent.includes('Ã‚&nbsp;') || 
                            textContent.trim() === 'Ã‚' || 
                            textContent.includes('\u00A0') ||
                            textContent.trim() === '') {
                            console.log('Removing unwanted text node:', textContent);
                            node.remove();
                        }
                    }
                    
                    // Also check for any unwanted elements that might contain the text
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        if (node.tagName === 'TEXT' || 
                            (node.textContent && node.textContent.includes('Ã‚&nbsp;'))) {
                            console.log('Removing unwanted element:', node);
                            node.remove();
                        }
                    }
                }
            }
            
            // Run cleanup immediately
            removeUnwantedTextNodes();
            
            // Set up mutation observer to catch any dynamically added text nodes
            const observer = new MutationObserver(function(mutations) {
                let shouldCleanup = false;
                
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.TEXT_NODE && 
                                (node.textContent.includes('Ã‚&nbsp;') || node.textContent.includes('\u00A0'))) {
                                shouldCleanup = true;
                            }
                        });
                    }
                });
                
                if (shouldCleanup) {
                    removeUnwantedTextNodes();
                }
            });
            
            // Start observing for new text nodes
            observer.observe(document.body, {
                childList: true,
                subtree: false // Only watch direct children of body
            });
            
            // Final cleanup after a short delay
            setTimeout(removeUnwantedTextNodes, 500);
        });
    </script>
</html>
